<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KTP Status Checklist</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind for modern styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Papa Parse for robust CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <main class="max-w-6xl mx-auto p-6">
    <div class="bg-white shadow rounded-xl p-5">
      <div class="flex items-center justify-between gap-4 mb-2">
        <h1 class="text-xl md:text-2xl font-bold text-green-700">Lab 4: Gas Absorption Status</h1>
        <div class="flex items-center gap-2">
          <button id="reload" class="px-3 py-2 text-sm bg-green-600 hover:bg-green-700 text-white rounded-md">Reload</button>
        </div>
      </div>

      <!-- Update date -->
      <p class="text-gray-600 mb-4">
        <span class="font-medium text-green-700">Update date:</span>
        <span id="update-date">â€”</span>
      </p>

      <!-- Notice -->
      <div id="notice" class="hidden mb-3 p-3 rounded-md bg-green-50 border border-green-200 text-green-800"></div>

      <div id="table-container" class="overflow-x-auto text-sm">Loading...</div>

      <p class="text-gray-600 mt-4">
        Remark: <span class="font-semibold">1 = Received</span>,
        <span class="font-semibold">0 = Not received</span>,
        <span class="font-semibold">- = Pending</span>
      </p>
    </div>

    <!-- Footer -->
    <footer class="text-center text-sm text-gray-600 mt-6">
      Dev by
      <a href="https://kantaphan.netlify.app/" class="text-green-700 hover:text-green-800 hover:underline" target="_blank" rel="noopener noreferrer">
        KTP
      </a>
    </footer>
  </main>

  <script>
    // CSV is already in the repo (same folder as this HTML)
    // If your CSV is in a subfolder, e.g., /data, change to './data/452-Check List-KTP.csv'
    const CSV_URL = encodeURI('./452-Check List-KTP.csv');

    // Only these columns (in this exact order) will be displayed:
    const TARGET_HEADERS = [
      'Grading Status', 'NO.', 'Date', 'Group', 'Safety',
      'Prelab', 'Full Report', 'Calculation', 'Due', 'Over Due'
    ];

    // Allow minor header variations (extra spaces, punctuation)
    const ACCEPTABLE_VARIANTS = {
      'Grading Status': ['Status'],
      'NO.': ['NO.', 'No.', 'NO', 'No', 'Number', 'No. '],
      'Date': ['Date', 'DATE'],
      'Group': ['Group', 'GROUP'],
      'Safety': ['Safety', 'SAFETY'],
      'Prelab': ['Prelab', 'Prelab ', 'Pre-lab', 'Pre lab'],
      'Full Report': ['Full Report', 'FullReport', 'Report'],
      'Calculation': ['Calculation', 'Calculations'],
      'Due': ['Due', 'DUE'],
      'Over Due': ['Over Due', 'Overdue', 'OverDue', 'Over  Due', 'Over  due']
    };

    // Normalize header by removing spaces/punctuation and lowering case
    const normalize = (s) =>
      String(s ?? '')
        .toLowerCase()
        .replace(/\s+/g, '')
        .replace(/[._-]+/g, '')
        .replace(/[:;/\\]+/g, '');

    function buildHeaderMap(csvHeaders) {
      const map = {};
      const normalizedCsv = csvHeaders.map(h => ({ raw: h, norm: normalize(h) }));

      for (const target of TARGET_HEADERS) {
        const variants = new Set([target, ...(ACCEPTABLE_VARIANTS[target] || [])]);

        // Try: exact raw | trimmed | normalized
        let found = csvHeaders.find(h => variants.has(h));
        if (!found) found = csvHeaders.find(h => variants.has(String(h).trim()));
        if (!found) {
          const normCandidates = [...variants].map(normalize);
          const match = normalizedCsv.find(o => normCandidates.includes(o.norm));
          if (match) found = match.raw;
        }
        map[target] = found || null;
      }
      return map;
    }

    function renderTable(rows, headerMap) {
      const container = document.getElementById('table-container');

      if (!rows || rows.length === 0) {
        container.innerHTML = '<p class="text-gray-500">No data available.</p>';
        return;
      }

      const missing = Object.entries(headerMap)
        .filter(([_, actual]) => !actual)
        .map(([wanted]) => wanted);

      const notice = document.getElementById('notice');
      if (missing.length) {
        notice.classList.remove('hidden');
        notice.textContent = `Warning: Missing columns in CSV: ${missing.join(', ')}`;
      } else {
        notice.classList.add('hidden');
        notice.textContent = '';
      }

      const thead = `
        <thead>
          <tr>
            ${TARGET_HEADERS.map(h => `
              <th class="px-3 py-2 bg-green-50 text-left font-semibold border-b border-gray-200">${h}</th>
            `).join('')}
          </tr>
        </thead>
      `;

      const tbody = `
        <tbody>
          ${rows.map(rowObj => {
            const tds = TARGET_HEADERS.map(h => {
              const actual = headerMap[h];
              const val = actual ? (rowObj[actual] ?? '') : '';
              return `<td class="px-3 py-2 border-b border-gray-100">${val}</td>`;
            }).join('');
            return `<tr class="odd:bg-gray-50 hover:bg-green-50 transition-colors">${tds}</tr>`;
          }).join('')}
        </tbody>
      `;

      container.innerHTML = `
        <table class="min-w-full border border-gray-200 rounded-lg overflow-hidden">
          ${thead}
          ${tbody}
        </table>
      `;
    }

    async function fetchCsvText(url) {
      // cache-busting for GitHub Pages and static hosting
      const bust = (url.includes('?') ? '&' : '?') + 't=' + Date.now();
      const res = await fetch(url + bust, { cache: 'no-store' });
      if (!res.ok) {
        const snippet = await res.text().catch(() => '');
        throw new Error(`Fetch failed: ${res.status} ${res.statusText}${snippet ? ' - ' + snippet.slice(0, 200) : ''}`);
      }
      return res.text();
    }

    async function loadAndRender() {
      const tableContainer = document.getElementById('table-container');
      const notice = document.getElementById('notice');
      const updateEl = document.getElementById('update-date');

      notice.classList.add('hidden');
      notice.textContent = '';
      tableContainer.innerHTML = 'Loading...';

      try {
        const text = await fetchCsvText(CSV_URL);
        updateEl.textContent = new Date().toLocaleString();

        const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
        if (parsed.errors && parsed.errors.length) {
          console.warn('Papa Parse warnings:', parsed.errors);
        }
        const rows = parsed.data || [];
        const headers = parsed.meta?.fields || [];

        const headerMap = buildHeaderMap(headers);
        renderTable(rows, headerMap);
      } catch (e) {
        console.error(e);
        tableContainer.innerHTML = `
          <div class="p-3 rounded-md bg-red-50 border border-red-200 text-red-700">
            <p class="font-semibold">Failed to load data.</p>
            <pre class="mt-2 text-xs whitespace-pre-wrap">${e.message}</pre>
          </div>
        `;
      }
    }

    document.getElementById('reload').addEventListener('click', loadAndRender);
    loadAndRender();
  </script>
</body>
</html>